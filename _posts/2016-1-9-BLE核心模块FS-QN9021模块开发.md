---
layout: post
title:  "BLE核心模块FS-QN9021模块开发-linux版"
categories: "work_lifes"
author: 吴兴章
tags: 工作生活
donate: true
comments: true
---
这段时间又参与了一个新的小项目，简单概括为`蓝牙、智能、家居`吧，虽然时间有点紧，还是希望能把这一些东西记录下来。

<br>
####BLE
什么是BLE？参考这篇[文章](http://www.mianfeiwendang.com/doc/e5f0219633d14d7b2d6ac032)做如下总结。    
中文名称为蓝牙低功耗。主要特点为低成本、超低功耗、短距离、标准接口和可互操作性强，并且工作在免许可的2.4GHz ISM射频段，需要支持蓝牙4.0（系统为Android4.3及以上）的主机设备才能与其连接。    

目前生产BLE芯片的厂家主要有CSR、TI、Nodic和NXP（QN902x），各个厂家芯片对比如下图

![s](http://www.mianfeiwendang.com/pic/e5f0219633d14d7b2d6ac032/2-340-png_6_0_0_0_0_0_0_892.979_1262.879-893-0-312-893.jpg)

从如上图对比可以看出，NXP的QN902x在功耗方面比CSR和TI更省电，在接收灵敏度和模式方面比Nodic的胜一筹，它的从设备相比其它几家可以连接的更多，共有8个，这也算是蓝牙4.0的一大特色吧，并且NXP的芯片已经过了MFI认证，直接能与苹果设备相连接，因为这种认证也是挺贵的。    

因为BLE的低功耗、低成本及强大的处理能力，并且随着iPhone的设备支持蓝牙4.0，BLE的终端设备在我们的生活当中将会越来越多，在未来将会有爆发式增长。

<!--more-->
QN902X是一款内核为M0的蓝牙BLE SOC芯片，其SDK对蓝牙BLE的profile都有实现，并提供源码，SDK也提供很多工具以便使用芯片，比如引脚配置，NVDS读写，串口USB Dongle(配合上位机可以调试各profile，没有手机也可以调试)，ISP下载等，但QN902X不提供数据手册，所有的外设操作都以库的方式提供，SDK说明比较全面但全是英文的。      

与NODRDIC的51822和TI的CC2540不同QN902X的架构是M0+ROM+FLASH+SRAM的方式，其中ROM放的是蓝牙协议和内部一个小的调度核，FLASH放的是用户程序和数据，RAM用于跑程序。其中ROM:96K，SRAM:64K，FLASH:64K/128K。因为QN902X程序是跑到SRAM中，所以它的深度睡眠电流比较大些。

<br>
####环境搭建
老生长谈，开发一款产品，第一步当然是搭建开发环境咯。

#####wine安装
由[这里](http://www.keil.com/demo/requirements.asp)可知，keil不支持linux环境，所以必须自己想办法了。这是在linux环境下运行windows的程序，本身使用windows的请自动忽略这一步。具体请看[官网](http://wiki.ubuntu.org.cn/Wine)/[博文](http://blog.csdn.net/ropai/article/details/19813767)。

```sh
~ $ sudo add-apt-repository ppa:ubuntu-wine/ppa
~ $ sudo apt-get update
# => 我的是64为的系统，所有安装64位版
~ $ sudo apt-get install wine1.8-amd64
# => 配置
~ $ winecfg
# => 中文路径：~/ .wine/drive_c/windows/Fonts/
~ $ winetricks corefonts
```

#####keil安装
首先得下载keil，可以自己去[官网](http://www.keil.com/download/)下载最新的，也可以直接点击[mdk5.17下载地址](http://www.keil.com/fid/1syem9w320dj1w1pcqw1dpsdaw3ocqd1mijw11/files/eval/mdk517.exe)，参考这篇[博文](http://www.rationmcu.com/elecjc/1204.html)并实践做如下记录。

```sh
# => 进入下载目录安装
~ $ wine mdk517.exe
```
> `提示`：卸载程序可以用wine uninstaller     
>如编译有限制，下载破解注册机Keygen：http://pan.baidu.com/s/1hqGSRqs

安装完成后，会弹出来一个安装器件（pack installer）如下的界面，也就是说，你要用它来开发哪个芯片（此项目可以忽略，后面步骤导入DB）。
![packin](/images/packin.png)

<br>
或者打开keil界面会看到如下图标
![packicon](/images/packicon.png)

<br>
要开发哪一款芯片，点击install即可，或者先网页端下载好在导入，具体参考上面提供的博文地址。

#####MCU DB库安装
下载Quintic最新的SDK[QBlue1.3.7](http://pan.baidu.com/s/1mgkQF2K#path=%252FFireBLE%252FSource)，安装：

```sh
~ $ wine QBlue-1.3.7.exe
```
会弹出窗口如下，点击安装即可，或者打开桌面QBlue里的QN9020DevDBforIDE工具安装。

![sdk](/images/9021db.png)

#####keil使用
首先获取开[源代码](https://bitbucket.org/T-Firefly/fireble/downloads)

```sh
~ $ cd
~ $ git clone git@bitbucket.org:T-Firefly/fireble.git
```
桌面打开keil，假如我们希望开始proxr工程：

1. 在keil的Project菜单中选择Open Project...
2. 弹出文件选择框中，打开/home/xxx/fireble/BLE/prj_proxr/keil/proxr.uvproj工程文件（linux可能在z磁盘里）
3. 配置DB如下，如果没发现库，请重启软件

	![dbset](/images/nxpset.png)
4. 编译代码，成功后如下，具体配置选项请参考[这里](http://wiki.t-firefly.com/index.php/FireBLE/Build_development_environment#JLink.E4.BB.BF.E7.9C.9F.E5.99.A8.E7.9A.84.E9.80.89.E6.8B.A9.E5.92.8C.E9.85.8D.E7.BD.AE)

	![compile](/images/compile.png)
5. 下载程序，下载的时候需要按复位键。

	![dl](/images/download.png)

>`Tip`:在ubuntu 上串口识别为ttyS0或ttyUSB0之类，在wine上识别不到，可用：

>```sh
># =>将其该为小写的com1 
>~ $ sudo ln -s /dev/ttyUSB0 ~/.wine/dosdevices/com1
>~ $ sudo usermod -a -G dialout $USER
>~ $ sudo chmod 777 ~/.wine/dosdevices/com1
```

>即可在wine的应用程序使用串口

<br>
####项目实践
#####点亮LED
对于新的芯片与开发板，从LED实验开始。首先下载该开发板的[原理图](http://www.t-firefly.com/download/FireBLE/docs/FireBLE_Sch&Pos&CAD.rar)，对该LED部分的电路进行分析。

![led](http://bbs.ickey.cn/plugins/pubs/kindeditor/attached/image/20150822/20150822213745_63743.png)

本程序非常简单，复制gpio demo代码

![gpio](http://bbs.ickey.cn/plugins/pubs/kindeditor/attached/image/20150822/20150822212438_56888.png)

实现让开发板D1灯闪烁如下：

```c
/* Set pin D1/P2_7 */
gpio_set_direction_field(GPIO_P27, (uint32_t)GPIO_OUTPUT);
while(1)
{
	gpio_write_pin_field(GPIO_P27, GPIO_LOW);
	delay(100000);
	gpio_write_pin_field(GPIO_P27, GPIO_HIGH);
	delay(100000);
}
```
程序流程：系统初始化-->GPIO配置-->各驱动模块初始化-->主循环实现功能     
效果如下：

![led](/images/ble_led.gif)

#####UART实验
串口通信可以用来打印数据，调试程序，有必要实验一下。    
同样复制uart demo代码    
改程序如下：

```c
//Print out "Hello NXP!\n" thought uart.
uart_printf(QN_UART0, (uint8_t *)"Hello NXP!\n");
uart_printf(QN_UART0, (uint8_t *)"This is nephen's test!\n");
```
波特率设置为115200，现象如下：
![uart_tst](/images/uart_test.png)

#####PWM实验
由于这个项目会控制到电机什么的，所以pwm少不了，这个实验是通过pwm控制陶瓷蜂鸣器报警和呼吸灯。通过PWM方式调节脉冲频率和占空比，变换LED亮度，渐变亮度实现呼吸灯效果。FireBLE板载的贴片蜂鸣器是压电式陶瓷蜂鸣器，压电陶瓷蜂鸣器要想响起来，需要满足四个条件：多谐振荡器、压电蜂鸣片、阻抗匹配器及共鸣箱，压电蜂鸣片由锆钛酸铅或铌镁酸铅压电陶瓷材料制成，在陶瓷片的两面镀上银电极，经极化和老化处理后，再与黄铜片或不锈钢片粘在一起。板载的蜂鸣器缺少的只是多谢振荡器，这里我们用PWM来代替，输出1.5KHz-2.5KHz的方波信号推动压电蜂鸣片发声，频率在1.5KHz-2.5KHz才会响，太高太低都不响，直接加3.3V更不会响，直接加3.3V响的那是电磁式蜂鸣器，有源和无源。    
首先看下电路连接

![buzz](http://bbs.ickey.cn/plugins/pubs/kindeditor/attached/image/20150902/20150902013258_57981.jpg)    

同样复制pwm代码，改写如下：

```c
int main (void)
{
    SystemInit();

    pwm_init(PWM_CH0);
    pwm_io_config();
    //P2.7 will output pwm wave with period for 1000us and pulse for 400us
    pwm_config(PWM_CH0, PWM_PSCAL_DIV, PWM_COUNT_US(1000, PWM_PSCAL_DIV), PWM_COUNT_US(500, PWM_PSCAL_DIV));
    pwm_enable(PWM_CH0, MASK_ENABLE);
    pwm_io_dis_config();

    pwm_init(PWM_CH1);
    pwm_io_config();
    //P2.6 will output pwm wave with period for 1000us and pulse for 500us
    pwm_config(PWM_CH1, 119, PWM_COUNT_US(1000, 119), PWM_COUNT_US(500, 119));
    pwm_enable(PWM_CH1, MASK_ENABLE);

    while (1)                                /* Loop forever */
    {
			int i;
			for(i=0;i<=1000;i++)
			{
				pwm_config(PWM_CH1, 119, PWM_COUNT_US(1000-i, 119), PWM_COUNT_US(500, 119));
				if(i%2)
					pwm_config(PWM_CH0, PWM_PSCAL_DIV, PWM_COUNT_US(1000-i, PWM_PSCAL_DIV), PWM_COUNT_US(500, PWM_PSCAL_DIV));
				else
					pwm_config(PWM_CH0, PWM_PSCAL_DIV, PWM_COUNT_US(i, PWM_PSCAL_DIV), PWM_COUNT_US(500, PWM_PSCAL_DIV));
				delay(2000);
			}
    }
}
```

呼吸灯效果：

![breath](/images/breath.gif)

<br>
####参考文档
- [FireBLE-wiki](http://wiki.t-firefly.com/index.php/FireBLE)
- [BLE编程API参考手册](http://www.t-firefly.com/download/FireBLE/docs/QN9020_API_Programming_Guide_v1.0.pdf)
- [BLE软件开发手册](http://www.t-firefly.com/download/FireBLE/docs/QN9020_Software_Developer_Guide_v1.4.pdf)
- [数据手册](http://www.t-firefly.com/download/FireBLE/docs/QN902X.pdf)
- [QN9020快速入门](http://www.nxp.com/documents/application_note/AN11664.pdf)
- [QN902x周立功版](http://www.zlgmcu.com/NXP/Qn902x/pdf/QN902x_fast_um.pdf)
- [防丢器项目](http://blog.csdn.net/q562359345)
- [MDK-ARM PRO SET](http://www.myir-tech.com/faq.asp?nid=37)
- [总有“一道菜”适合你——BLE](http://www.qiuzhi5.com/13/2015/1222/200559.html)
- [【FireBLE试用体验】体验报告汇总](http://bbs.ickey.cn/index.php?app=group&ac=topic&id=56566)
- [FireBLE 开发板试用汇总贴（2015.11.29更新 共收录145篇）  [板块置顶]  [精华]](http://bbs.ickey.cn/group-topic-id-54243.html)
- [FireBLE驱动第一篇：呼吸灯](http://developer.t-firefly.com/forum.php?mod=viewthread&tid=1000&highlight=FireBLE)
- [FireBLE低功耗蓝牙开发板评测 > 可穿戴手环+蓝牙防丢器](http://www.eeboard.com/evaluation/fireble/)
- [esp8266](http://www.arduino.cn/thread-7540-1-1.html)