---
layout: post
title:  "初学PX4之环境搭建"
categories: "drons_lifes"
author: nephne
tags: 工作生活
donate: true
comments: true
---
####前言
前段时间linux崩溃了，桌面进去后只有背景，折腾好久没搞定，为了节省时间索性重装了系统，同时也借这个机会从头记载一下作为初学者的学习过程。主要是按PX4的官网初学者教程进行，把其中遇到的一些初学者容易遇到的问题罗列出来，由于对于国内这方面的资料相对缺乏，希望能给大家提供一些帮助，也算是自我学习的一个整理。

<!--more-->
如果你还不是很了解关于飞行器的这个项目PX4，建议迅速跳到PX4的[官网](https://pixhawk.org/start?id=start)一探究竟。简单来说，PX4是一个软、硬件开源项目（遵守BSD协议），目的在于为学术、爱好和工业团体提供一款低成本高性能的高端的自驾仪。这个项目源于 [ETH Zurich (苏黎世联邦理工大学)的计算机视觉与几何实验室](http://cvg.ethz.ch/)的[PIXHAWK项目](http://pixhawk.ethz.ch/)、并得到了[自主系统实验室](http://www.asl.ethz.ch/)和 [自动控制实验室](http://control.ee.ethz.ch/)的支持 ，以及一些出色的个人([Contact and Credits](https://pixhawk.org/credits))也参与其中，包括 [3D Robotics](http://store.diydrones.com/category_s/63.htm) 和 [international 3DR distributors](http://diydrones.com/profiles/blogs/list-of-all-diy-drones)的成员。

####前期准备
为了让大家能与我的学习保持同步，先介绍一下在搭建这个PX4环境前我已经做好的工作：

1. 硬件一套，包括DJI F450机架、Pixhawk 2.4.6 mini飞控、好盈乐天20A电调、1045正反桨、银燕电机2216、天地飞6通道遥控器。详情见淘宝链接里的[套餐方案](https://item.taobao.com/item.htm?spm=a1z10.5-c.w4002-8717792970.38.rv3aHa&id=41190426449)。
2. 软件环境，使用的最新发行版[Ubuntu 15.10](http://www.ubuntu.org.cn/download/desktop)操作系统。

####工具链安装
在准备工作做好并对PX4有了一定的了解后，从[开发者快速入门教程](https://pixhawk.org/dev/quickstart)开始PX4的环境搭建，对于`Linux`这里直接跳到了[工具链](http://dev.px4.io/starting-installing-linux.html)的安装。按照教程说的命令去执行就可以了，只要你的网速够好，相信很快就能完成任务。说明一下这里做了哪些事情：

1. 更新软件包列表并安装所有PX4构建目标的依赖，注意一点：`sudo apt-get install gcc-arm-none-eabi=4.8.3-18ubuntu2+12 -y`。
2. ubuntu自带的串口调制解调器严重的影响到了机器人串口相关的使用，可以没有任何副作用的卸载掉。
3. 安装模拟工具CLANG 3.5。
4. 添加当前用户到组”dialout“(如果这步没做，会导致很多用户权限问题)。

####代码编译
然后就到了编译代码的阶段，那么首先得弄到代码，按照[这个](http://dev.px4.io/starting-building.html)里面的步骤去做就好了，经测试ubuntu 14.04编译没有出现问题，建议安装[ninja](http://dev.px4.io/starting-installing-linux-boutique.html#ninja-build-system)，它编译的速度比make要快，想必有不懂Git是个啥的童鞋，那就看看这个[Git教程-廖雪峰的官方网站](http://www.liaoxuefeng.com/wiki/0013739516305929606dd18361248578c67b8067c8c017b000/)吧，保证有帮助。比如我们的项目可以这么做：

```sh
# => 本地创建文件夹，并关联远程仓库
~ $ sudo apt-get install git-all
~ $ makedir YuningFly
~ $ cd YuningFly
~/YuningFly $ git init
~/YuningFly $ git add *
~/YuningFly $ git commit -m "Commit message"
~/YuningFly $ git remote add origin git@github.com:{{username}}/{{repository}}
~/YuningFly $ git push -u origin master
```

通过ssh支持的原生git协议速度最快，但是要先生成SSH keys，见[教程](https://help.github.com/articles/generating-ssh-keys/)，克隆开源代码可以用

```sh
~ $ git clone git@github.com:PX4/Firmware.git
```

*-------ubuntu15.10 issues!!!----*

1. gcc的版本过高，需要进行[降级](http://blog.sina.com.cn/s/blog_6cee149d010129bl.html)，这是我自己做的记录，大家不需要做。
2. 如果你跟我一样用的是ubuntu 15.10，需要进行arm-none-eabi重新安装，首先了解见[博文](http://www.veryarm.com/296.html)，然后去GNU官方下载地址：[https://launchpad.net/gcc-arm-embedded/+download](https://launchpad.net/gcc-arm-embedded/+download)下载`gcc-arm-none-eabi-4_8-2014q3-20140805-linux.tar.bz2`，然后进入下载文件夹，进行如下操作：

```sh
~ $ tar xjvf gcc-arm-none-eabi-4_8-2014q3-20140805-linux.tar.bz2
~ $ sudo mv gcc-arm-none-eabi-4_8-2014q3 /opt
~ $ exportline="export PATH=/opt/gcc-arm-none-eabi-4_8-2014q3/bin:$PATH"
~ $ echo $exportline >> ~/.profile
~ $ sudo ln -s /opt/gcc-arm-none-eabi-4_8-2014q3/bin/arm-none-eabi-gcc /usr/bin
~ $ sudo ln -s /opt/gcc-arm-none-eabi-4_8-2014q3/bin/arm-none-eabi-g++ /usr/bin
```

如果PC是ubuntu 64位系统，arm-linux-gcc是直接下载人家编译好的32位的话，还需要一个东东：

```sh
sudo apt-get install lsb-core
```
make成功后如下：

![makeokay](/images/makeokay.png)

*-------ubuntu15.10 issues-------*

这里要做的事情主要是：

1. 克隆PX4软件到本地，
2. make编译，
3. 连接USB到无人机硬件，上传固件

####软件在环测试（SITL）
在直接到硬件之前，建议将模拟运行作为下一步。这个东西看起来很高端，有点摸不着头脑，以前没接触过，也觉得很深奥。跳到[这里](http://dev.px4.io/simulation-sitl.html)，看看赋予它的概念：软件在环仿真运行的主机上的完整系统，并模拟自动驾驶仪。它通过本地网络连接到模拟器。启动运行如下：

![sitl](/assets/sitl.png)

下面请将想办法给大家介绍清楚这个东西是什么，怎么用到PX4上，用到它有什么作用：

*建议：如果有比较棘手的问题，可以在[这里](https://gitter.im/PX4/Firmware)提问，好多不解的问题可以少走很多路。比如：*

![gitter](/images/gitter.png)

可以先了解PX4仿真的一些[概念](https://pixhawk.org/dev/simulation/start)。PX4平台支持软件在环和硬件在环仿真。不同的是，使用SITL时，完整的模拟运行在主机（台式机、笔记本电脑），没有自动驾驶仪的硬件连接。这是测试新的算法和控制的最优办法，但它忽略了类似的硬件时间消耗或类似于堆栈大小的限制的事情。硬件在环仿真解决了这个问题，但是它的建立过程比较费时，因为硬件需要启动和刷新固件。软件在环仿真又分两种：标准软件在环仿真和ROS软件在环仿真。官方推荐使用标准软件在环仿真。标准软件在环仿真在单一的应用程序里以线程的形式最小依赖运行每个控制器和估算器。

下面是具体该怎么[操作](https://pixhawk.org/dev/simulation/native_sitl)。