---
layout: post
title:  "初学PX4之操作系统"
categories: "drons_lifes"
author: nephne
tags: 工作生活
donate: true
comments: true
---
这篇文章主要是对PX4底层操作系统的熟悉，为后期的应用程序编写及飞控算法研究做准备。参考[官方文档](http://dev.px4.io/advanced-system-startup.html)做如下记载。

<!--more-->
<br>
####系统启动
PX4的开机是通过[ROMFS/px4fmu_common/init.d](https://github.com/PX4/Firmware/tree/master/ROMFS/px4fmu_common/init.d)文件夹里的shell脚本控制的。

所有以数字和下划线开头的文件属于包装的机身配置。他们在构建的时候被导出为airframes.xml文件，这些文件被QGroundControl解析作为机身选择界面。其余文件是通用启动逻辑的一部分，首先执行的文件是rcS脚本，通过它调用其它的脚本。

<br>
####调试系统启动
一个软件组件的驱动程序的失败可能导致中止启动。

	注意：一个不完整的引导往往体现在地面控制站缺少参数，因为非启动的应用程序没有初始化参数。

调试启动顺序正确的方法是，连接系统控制台然后给电路板重新上电。由此产生的引导日志具有启动序列的详细信息，并且应该包含提示为什么中止启动。

**常见的启动失败原因**

- 一个必须的传感器启动失败
- 对于自定义应用程序：系统内存溢出。运行free命令查看剩余的RAM
- 一个软件故障或断言导致堆栈轨迹

<br>
####个性化系统启动
自定义系统启动的最佳方式是介绍一种新的机身配置。如果只调整需要（如再启动一个应用或只是使用一个不同的混合器），在启动文件有特殊的钩子可以使用。（*钩子的本质是一段用以处理系统消息的程序，通过系统调用，将其挂入到系统。钩子的
种类有很多，每一种钩子负责截获并处理相应的消息。*）

	警告：系统启动文件是UNIX文件，需要UNIX LINE ENDINGS，如果在windows上请使用合适的编辑器。

这里有三个钩子。注意，microSD卡的根文件夹的路径为`/fs/microsd`。

- /fs/microsd/etc/config.txt
- /fs/microsd/etc/extras.txt
- /fs/microsd/mixers/NAME_OF_MIXER

<br>
####自定义配置(config.txt)

config.txt文件是在主系统完成配置后，启动前导入的，它允许修改shell变量。

**开始附加应用程序**

extra.txt能被用来主系统启动后开始附加应用程序。通常情况下，这些将是有效载荷控制器或类似的可选自定义组件。

**开始自定义混合器**

默认情况下，系统从/etc/mixers导入混合器。如果具有相同名称的文件存在于/fs/microsd/etc/mixers，文件将被加载。这允许定制混合文件而不需要重新编译固件。

<br>
####uORB消息
**简介**

uORB是一个发布/订阅通讯工具。

**列出主题和监听**

列出所有主题，列出文件句柄：

```sh
ls /obj
```

要听一个主题的内容的5个消息，运行监听：

```sh
listener sensor_accel 5
```

输出是n次主题的内容：

```sh
TOPIC: sensor_accel #3
timestamp: 84978861
integral_dt: 4044
error_count: 0
x: -1
y: 2
z: 100
x_integral: -0
y_integral: 0
z_integral: 0
temperature: 46
range_m_s2: 78
scaling: 0

TOPIC: sensor_accel #4
timestamp: 85010833
integral_dt: 3980
error_count: 0
x: -1
y: 2
z: 100
x_integral: -0
y_integral: 0
z_integral: 0
temperature: 46
range_m_s2: 78
scaling: 0
```